"use strict";(self.webpackChunkelemental_docs=self.webpackChunkelemental_docs||[]).push([[939],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>h});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),c=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},p=function(e){var t=c(e.components);return a.createElement(s.Provider,{value:t},e.children)},m="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,s=e.parentName,p=o(e,["components","mdxType","originalType","parentName"]),m=c(n),u=r,h=m["".concat(s,".").concat(u)]||m[u]||d[u]||i;return n?a.createElement(h,l(l({ref:t},p),{},{components:n})):a.createElement(h,l({ref:t},p))}));function h(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,l=new Array(i);l[0]=u;var o={};for(var s in t)hasOwnProperty.call(t,s)&&(o[s]=t[s]);o.originalType=e,o[m]="string"==typeof e?e:r,l[1]=o;for(var c=2;c<i;c++)l[c]=n[c];return a.createElement.apply(null,l)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},6604:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>l,default:()=>d,frontMatter:()=>i,metadata:()=>o,toc:()=>c});var a=n(7462),r=(n(7294),n(3905));const i={sidebar_label:"Machine Reset",title:"",version_badge:"1.3.0"},l=void 0,o={unversionedId:"reset",id:"reset",title:"",description:"Machine Reset",source:"@site/docs/reset.md",sourceDirName:".",slug:"/reset",permalink:"/next/reset",draft:!1,tags:[],version:"current",frontMatter:{sidebar_label:"Machine Reset",title:"",version_badge:"1.3.0"},sidebar:"docs",previous:{title:"Inventory Management",permalink:"/next/inventory-management"},next:{title:"Backup",permalink:"/next/backup"}},s={},c=[{value:"Machine Reset",id:"machine-reset",level:2},{value:"Reset workflow",id:"reset-workflow",level:3},{value:"Enable machine reset",id:"enable-machine-reset",level:3}],p={toc:c},m="wrapper";function d(e){let{components:t,...i}=e;return(0,r.kt)(m,(0,a.Z)({},p,i,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h2",{id:"machine-reset"},"Machine Reset"),(0,r.kt)("p",null,"There are two ways to reset Elemental machines to their original state or decommission them:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"When deleting a Cluster, all associated machines will be reset  ")),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Delete a Cluster to reset all machines",src:n(8852).Z,width:"1241",height:"359"})),(0,r.kt)("ol",{start:2},(0,r.kt)("li",{parentName:"ol"},"When managing a Cluster, simply delete the Node that needs to be reset  ")),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Delete a single node to reset it",src:n(9830).Z,width:"1241",height:"774"})),(0,r.kt)("h3",{id:"reset-workflow"},"Reset workflow"),(0,r.kt)("p",null,"Once the related ",(0,r.kt)("inlineCode",{parentName:"p"},"MachineInventory")," is flagged for deletion, a reset plan will be executed by the ",(0,r.kt)("inlineCode",{parentName:"p"},"elemental-system-agent")," running on the machine.  "),(0,r.kt)("p",null,"If the machine is still running, this plan will:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Reboot the machine in recovery mode."),(0,r.kt)("li",{parentName:"ol"},"Execute ",(0,r.kt)("inlineCode",{parentName:"li"},"systemctl start elemental-register-reset"),".",(0,r.kt)("br",{parentName:"li"}),"This will fetch the remote ",(0,r.kt)("inlineCode",{parentName:"li"},"MachineRegistration")," and apply the ",(0,r.kt)("inlineCode",{parentName:"li"},"spec.config.elemental.reset")," options to reset the machine.",(0,r.kt)("br",{parentName:"li"}),"A new ",(0,r.kt)("inlineCode",{parentName:"li"},"MachineInventory")," will be created and the ",(0,r.kt)("inlineCode",{parentName:"li"},"spec.config.cloud-config")," defined in the ",(0,r.kt)("inlineCode",{parentName:"li"},"MachineRegistration")," will be applied again.  ")),(0,r.kt)("p",null,"Note that the ",(0,r.kt)("inlineCode",{parentName:"p"},"MachineRegistration")," reference will ",(0,r.kt)("strong",{parentName:"p"},"not")," change, the machine will ",(0,r.kt)("strong",{parentName:"p"},"not")," be reinstalled, the ",(0,r.kt)("inlineCode",{parentName:"p"},"COS_PERSISTENT")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"COS_OEM")," partition will be cleared by default if reset is ",(0,r.kt)("inlineCode",{parentName:"p"},"enabled"),". For more information, you can consult the ",(0,r.kt)("a",{parentName:"p",href:"installation#deployed-elemental-teal-partition-table"},"Partition Table"),".  "),(0,r.kt)("p",null,"Since the ",(0,r.kt)("inlineCode",{parentName:"p"},"cloud-config")," is re-applied during the reset workflow, you can reset a machine to apply updates from the ",(0,r.kt)("inlineCode",{parentName:"p"},"MachineRegistration")," definition, for example to rotate ",(0,r.kt)("inlineCode",{parentName:"p"},"users")," credentials and authorized keys. It is strongly recommended to enable the ",(0,r.kt)("inlineCode",{parentName:"p"},"reset-oem")," option, to avoid conflicts with previously configured cloud-configs.  "),(0,r.kt)("p",null,"If you need to bind a machine to a different ",(0,r.kt)("inlineCode",{parentName:"p"},"MachineRegistration")," and trigger a new full installation, you need to reprovision it again using a new image.  "),(0,r.kt)("h3",{id:"enable-machine-reset"},"Enable machine reset"),(0,r.kt)("p",null,"In order to allow machines to be reset automatically, the ",(0,r.kt)("inlineCode",{parentName:"p"},"spec.config.elemental.reset.enabled")," flag of the ",(0,r.kt)("inlineCode",{parentName:"p"},"MachineRegistration")," should be toggled.",(0,r.kt)("br",{parentName:"p"}),"\n","This is off by default, but once activated, all newly created ",(0,r.kt)("inlineCode",{parentName:"p"},"MachineInventory")," will inherit this setting automatically.",(0,r.kt)("br",{parentName:"p"}),"\n","For example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: elemental.cattle.io/v1beta1\nkind: MachineRegistration\nmetadata:\n  name: fire-nodes\n  namespace: fleet-default\nspec:\n  config:\n    elemental:\n      reset:\n        enabled: true\n        reset-persistent: true\n        reset-oem: true\n        # These cloud-init configs will be created during reset and will persist on the system after\n        config-urls: \n          - "https://my.cloud.init/reset-plan-1.yaml"\n          - "https://my.cloud.init/reset-plan-2.yaml"\n        # You can select a different image to run the reset.  \n        # Note that this image will not be installed on the system.\n        system-uri: "my.oci.registry/reset-image:latest"\n        power-off: false\n        reboot: true\n')),(0,r.kt)("p",null,"It is also possible to enable reset at a ",(0,r.kt)("inlineCode",{parentName:"p"},"MachineInventory")," level, for example in scenarios where some machines are physical and will benefit from an automatic reset, and some others are virtual and can simply be destroyed and reprovisioned as needed.",(0,r.kt)("br",{parentName:"p"}),"\n","In order to flag a single ",(0,r.kt)("inlineCode",{parentName:"p"},"MachineInventory")," to allow reset, you can use the ",(0,r.kt)("inlineCode",{parentName:"p"},"elemental.cattle.io/resettable: true")," annotation.",(0,r.kt)("br",{parentName:"p"}),"\n","For example:  "),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: elemental.cattle.io/v1beta1\nkind: MachineInventory\nmetadata:\n  annotations:\n    elemental.cattle.io/resettable: "true"\n')))}d.isMDXComponent=!0},8852:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/reset-cluster-deletion-b98a4f075a3a0600df55a5c847733fe6.png"},9830:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/reset-single-node-deletion-09c47aa5a8f695cb4bfe5eacefbf2bcb.png"}}]);