"use strict";(self.webpackChunkelemental_docs=self.webpackChunkelemental_docs||[]).push([[6625],{3905:(e,n,t)=>{t.d(n,{Zo:()=>p,kt:()=>h});var a=t(7294);function o(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function i(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function r(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?i(Object(t),!0).forEach((function(n){o(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function l(e,n){if(null==e)return{};var t,a,o=function(e,n){if(null==e)return{};var t,a,o={},i=Object.keys(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||(o[t]=e[t]);return o}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(o[t]=e[t])}return o}var s=a.createContext({}),c=function(e){var n=a.useContext(s),t=n;return e&&(t="function"==typeof e?e(n):r(r({},n),e)),t},p=function(e){var n=c(e.components);return a.createElement(s.Provider,{value:n},e.children)},m="mdxType",d={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},u=a.forwardRef((function(e,n){var t=e.components,o=e.mdxType,i=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),m=c(t),u=o,h=m["".concat(s,".").concat(u)]||m[u]||d[u]||i;return t?a.createElement(h,r(r({ref:n},p),{},{components:t})):a.createElement(h,r({ref:n},p))}));function h(e,n){var t=arguments,o=n&&n.mdxType;if("string"==typeof e||o){var i=t.length,r=new Array(i);r[0]=u;var l={};for(var s in n)hasOwnProperty.call(n,s)&&(l[s]=n[s]);l.originalType=e,l[m]="string"==typeof e?e:o,r[1]=l;for(var c=2;c<i;c++)r[c]=t[c];return a.createElement.apply(null,r)}return a.createElement.apply(null,t)}u.displayName="MDXCreateElement"},6357:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>s,contentTitle:()=>r,default:()=>d,frontMatter:()=>i,metadata:()=>l,toc:()=>c});var a=t(7462),o=(t(7294),t(3905));const i={sidebar_label:"Reset",title:""},r="Troubleshooting reset",l={unversionedId:"troubleshooting-reset",id:"version-1.3/troubleshooting-reset",title:"",description:'Each MachineInventory with the elemental.cattle.io/resettable: "true" annotation will trigger the execution of a reset plan, upon deletion.',source:"@site/versioned_docs/version-1.3/troubleshooting-reset.md",sourceDirName:".",slug:"/troubleshooting-reset",permalink:"/troubleshooting-reset",draft:!1,tags:[],version:"1.3",frontMatter:{sidebar_label:"Reset",title:""},sidebar:"docs",previous:{title:"Upgrade",permalink:"/troubleshooting-upgrade"},next:{title:"Release Notes",permalink:"/release-notes"}},s={},c=[{value:"Forcefully deleting a MachineInventory undergoing reset",id:"forcefully-deleting-a-machineinventory-undergoing-reset",level:2}],p={toc:c},m="wrapper";function d(e){let{components:n,...t}=e;return(0,o.kt)(m,(0,a.Z)({},p,t,{components:n,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"troubleshooting-reset"},"Troubleshooting reset"),(0,o.kt)("p",null,"Each ",(0,o.kt)("inlineCode",{parentName:"p"},"MachineInventory")," with the ",(0,o.kt)("inlineCode",{parentName:"p"},'elemental.cattle.io/resettable: "true"')," annotation will trigger the execution of a reset plan, upon deletion.",(0,o.kt)("br",{parentName:"p"}),"\n","The ",(0,o.kt)("inlineCode",{parentName:"p"},"machineinventory.elemental.cattle.io")," finalizer is going to be removed only after the plan has been executed successfully by the ",(0,o.kt)("inlineCode",{parentName:"p"},"elemental-system-agent")," running on the machine.  "),(0,o.kt)("p",null,"You can investigate why a ",(0,o.kt)("inlineCode",{parentName:"p"},"MachineInventory")," has not been deleted yet, by examining it:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: elemental.cattle.io/v1beta1\nkind: MachineInventory\nmetadata:\n  # deletionTimestamp has been set. This object has been marked for deletion.\n  deletionTimestamp: "2023-08-04T08:41:25Z"\n  annotations:\n    # `resettable` annotation is enabled.\n    # This means the machine has to go through reset, before deletion of this object.\n    elemental.cattle.io/resettable: "true"\n  # `machineinventory.elemental.cattle.io` finalizer is set.\n  #  The `elemental-operator` is going to create a reset plan for the machine to execute.\n  #  After successful execution of the reset plan, the finalizer is removed and the object will be deleted.\n  finalizers:\n  - machineinventory.elemental.cattle.io\nstatus:\n  conditions:\n  # Most recent condition shows that the MachineInventory is waiting for a plan to be applied.\n  - lastTransitionTime: "2023-08-04T08:41:25Z"\n    message: waiting for plan to be applied\n    reason: WaitingForPlan\n    status: "False"\n    type: Ready\n  # The plan to be executed is referenced. \n  # Normally it has the same name of the MachineInventory and lives within the same namespace.   \n  plan:\n    checksum: 5aba8b6b3161bc52d8953b2428e54ecda3b59e8e0043b49d761d1e79174eded6\n    secretRef:\n      name: m-bf1008a1-61d6-4355-b5f5-f7d1c527affe\n      namespace: fleet-default\n')),(0,o.kt)("p",null,"You can also examine the referenced plan ",(0,o.kt)("inlineCode",{parentName:"p"},"Secret"),".",(0,o.kt)("br",{parentName:"p"}),"\n","Note that the ",(0,o.kt)("inlineCode",{parentName:"p"},"elemental-system-agent")," running on the machine is watching this secret and it should execute the plan.",(0,o.kt)("br",{parentName:"p"}),"\n","You can also monitor its progress from the machine logs: ",(0,o.kt)("inlineCode",{parentName:"p"},"journalctl -u elemental-system-agent -f"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: v1\nkind: Secret\n# This is a `elemental.cattle.io/plan` secret plan.\ntype: elemental.cattle.io/plan\nmetadata:\n  annotations:\n    # This is a `reset` plan type.\n    elemental.cattle.io/plan.type: reset\n  labels:\n    elemental.cattle.io/managed: "true"\n  name: m-bf1008a1-61d6-4355-b5f5-f7d1c527affe\n  namespace: fleet-default\n  # It is owned by the `MachineInventory` waiting for deletion.\n  ownerReferences:\n  - apiVersion: elemental.cattle.io/v1beta1\n    controller: true\n    kind: MachineInventory\n    name: m-bf1008a1-61d6-4355-b5f5-f7d1c527affe\n    uid: 5aa3863c-63a5-4cb9-91fd-7a45191d4842\ndata:\n  # The plan has not been applied yet.\n  applied-checksum: ""\n  # It also hasn\'t failed.\n  failed-checksum: ""\n  # The actual plan to be executed, base64 encoded.\n  plan: eyJmaWxlcyI6W3siY29udGVudCI6ImJtRnRaVG9nUld4bGJXVnVkR0ZzSUZKbGMyVjBDbk4wWVdkbGN6b0tJQ0FnSUc1bGRIZHZjbXN1WVdaMFpYSTZDaUFnSUNBZ0lDQWdMU0JqYjIxdFlXNWtjem9LSUNBZ0lDQWdJQ0FnSUNBZ0xTQmxiR1Z0Wlc1MFlXd3RjbVZuYVhOMFpYSWdMUzFrWldKMVp5QXRMWEpsYzJWMENpQWdJQ0FnSUNBZ0lDQnBaam9nSjFzZ0xXWWdMM0oxYmk5amIzTXZjbVZqYjNabGNubGZiVzlrWlNCZEp3b2dJQ0FnSUNBZ0lDQWdibUZ0WlRvZ1VuVnVjeUJsYkdWdFpXNTBZV3dnY21WelpYUUsiLCJwYXRoIjoiL29lbS9yZXNldC1jbG91ZC1jb25maWcueWFtbCIsInBlcm1pc3Npb25zIjoiMDYwMCJ9XSwiaW5zdHJ1Y3Rpb25zIjpbeyJuYW1lIjoiY29uZmlndXJlIG5leHQgYm9vdCB0byByZWNvdmVyeSBtb2RlIiwiYXJncyI6WyIvb2VtL2dydWJlbnYiLCJzZXQiLCJuZXh0X2VudHJ5PXJlY292ZXJ5Il0sImNvbW1hbmQiOiJncnViMi1lZGl0ZW52In0seyJuYW1lIjoic2NoZWR1bGUgcmVib290IiwiYXJncyI6WyItciIsIisxIl0sImNvbW1hbmQiOiJzaHV0ZG93biJ9XX0K\n')),(0,o.kt)("p",null,"The plan created by the ",(0,o.kt)("inlineCode",{parentName:"p"},"elemental-operator")," should contain the following instructions:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "files": [\n    // A cloud-init config file is created on the default /oem directory.  \n    // This config will be executed once in recovery mode.\n    {\n      "content": "bmFtZTogRWxlbWVudGFsIFJlc2V0CnN0YWdlczoKICAgIG5ldHdvcmsuYWZ0ZXI6CiAgICAgICAgLSBjb21tYW5kczoKICAgICAgICAgICAgLSBlbGVtZW50YWwtcmVnaXN0ZXIgLS1kZWJ1ZyAtLXJlc2V0CiAgICAgICAgICBpZjogJ1sgLWYgL3J1bi9jb3MvcmVjb3ZlcnlfbW9kZSBdJwogICAgICAgICAgbmFtZTogUnVucyBlbGVtZW50YWwgcmVzZXQK",\n      "path": "/oem/reset-cloud-config.yaml",\n      "permissions": "0600"\n    }\n  ],\n  "instructions": [\n    {\n      "name": "configure next boot to recovery mode",\n      "args": [\n        "/oem/grubenv",\n        "set",\n        "next_entry=recovery"\n      ],\n      "command": "grub2-editenv"\n    },\n    {\n      "name": "schedule reboot",\n      "args": [\n        "-r",\n        "+1"\n      ],\n      "command": "shutdown"\n    }\n  ]\n}\n')),(0,o.kt)("p",null,"If the ",(0,o.kt)("inlineCode",{parentName:"p"},"elemental-system-agent")," successfully executed the plan, the ",(0,o.kt)("inlineCode",{parentName:"p"},"machineinventory.elemental.cattle.io")," finalizer on the ",(0,o.kt)("inlineCode",{parentName:"p"},"MachineInventory")," will be removed and the ",(0,o.kt)("inlineCode",{parentName:"p"},"MachineInventory")," will be deleted.",(0,o.kt)("br",{parentName:"p"}),"\n","Note that this is not an indication that the machine has been fully reset yet.",(0,o.kt)("br",{parentName:"p"}),"\n","This is a limitation of the current implementation and it will eventually improve, so that it will be possible to completely track the reset status.  "),(0,o.kt)("p",null,"However, at this stage we do expect the host to undergo reboot, and reboot in recovery mode.",(0,o.kt)("br",{parentName:"p"}),"\n","Once in recovery mode, the ",(0,o.kt)("inlineCode",{parentName:"p"},"cos-setup-network")," should execute the cloud-init config that has been written on ",(0,o.kt)("inlineCode",{parentName:"p"},"/oem/reset-cloud-config.yaml"),".",(0,o.kt)("br",{parentName:"p"}),"\n","You can monitor the status with ",(0,o.kt)("inlineCode",{parentName:"p"},"journalctl -u cos-setup-network -f"),"."),(0,o.kt)("p",null,"The cloud-init instructions should look like the following:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"name: Elemental Reset\nstages:\n    network.after:\n        - if: '[ -f /run/cos/recovery_mode ]'\n          name: Runs elemental reset\n          commands:\n            - systemctl start elemental-register-reset\n")),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"elemental-register")," cli will register with the ",(0,o.kt)("inlineCode",{parentName:"p"},"elemental-operator")," as a new machine. This will lead to the creation of a new ",(0,o.kt)("inlineCode",{parentName:"p"},"MachineInventory")," object.",(0,o.kt)("br",{parentName:"p"}),"\n","The remote ",(0,o.kt)("inlineCode",{parentName:"p"},"MachineRegistration")," configuration will also be fetched to apply the reset options, for example ",(0,o.kt)("inlineCode",{parentName:"p"},"reset-persistent"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"reset-oem"),", or the power settings, either ",(0,o.kt)("inlineCode",{parentName:"p"},"reboot")," or ",(0,o.kt)("inlineCode",{parentName:"p"},"power-off"),".",(0,o.kt)("br",{parentName:"p"}),"\n","After reset, depending on the settings, the machine should either shut down or reboot and be ready to be adopted within a new cluster.  "),(0,o.kt)("h2",{id:"forcefully-deleting-a-machineinventory-undergoing-reset"},"Forcefully deleting a MachineInventory undergoing reset"),(0,o.kt)("p",null,"If the machine is unable to execute the reset instructions and the related ",(0,o.kt)("inlineCode",{parentName:"p"},"MachineInventory")," is not deleted, there are two equivalent ways you can manually fix the issue."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Remove the ",(0,o.kt)("inlineCode",{parentName:"li"},'elemental.cattle.io/resettable: "true"')," annotation from the ",(0,o.kt)("inlineCode",{parentName:"li"},"MachineInventory"),".  "),(0,o.kt)("li",{parentName:"ul"},"Remove the ",(0,o.kt)("inlineCode",{parentName:"li"},"machineinventory.elemental.cattle.io")," finalizer from the ",(0,o.kt)("inlineCode",{parentName:"li"},"MachineInventory"),".  ")),(0,o.kt)("p",null,"Remember to also take care of the machine itself, by fully reprovisioning it or rebooting into recovery mode and using the ",(0,o.kt)("inlineCode",{parentName:"p"},"elemental reset")," command directly."))}d.isMDXComponent=!0}}]);